#!/bin/bash
: "${taito_plugin_path:?}"
: "${taito_env:?}"

if [[ "${taito_env}" != "local" ]]; then
  (
    all=$(taito::print_targets_of_type database)
    databases=("${taito_target:-$all}")
    for database in ${databases[@]}
    do
      export taito_target="${database}"
      . "${taito_util_path}/read_database_config.bash" "${database}" && \

      if [[ "${database_type:-}" == "pg" ]] || [[ -z "${database_type}" ]]; then
        . "${taito_util_path}/database_username_password.bash" && \

        if [[ -n ${database_build_password:-} ]] && \
           [[ -n ${database_app_password:-} ]] && ( \
             [[ ${database_build_password_changed:-} ]] || \
             [[ ${database_app_password_changed:-} ]]
           ); then
          if taito::confirm_execution "postgres" "" \
            "Set new passwords for postgres database ${database_name:-}"
          then
            export database_username=${database_master_username:-postgres}
            echo "HINT: You can get the ${database_username} user password from:"
            echo "${database_master_password_hint:-}"
            "${taito_plugin_path}/util/create-users" && \
            echo "Altered database user passwords for database ${database_name:-}"
          fi
        fi
      fi
    done
  )
fi && \

taito::call_next "${@}"
