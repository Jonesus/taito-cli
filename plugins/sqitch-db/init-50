#!/bin/bash
: "${taito_util_path:?}"
: "${taito_plugin_path:?}"
: "${taito_env:?}"

switches=" ${*} "

(
  all=$("$taito_util_path/get-targets-by-type" database)
  databases=("${taito_target:-$all}")
  for database in ${databases[@]}
  do
    export taito_target="${database}"
    . "${taito_util_path}/read-database-config" "${database}" && \

    if [[ "${switches}" == *"--clean"* ]]; then
      echo "Rebasing database ${database_name:?}"
      "${taito_plugin_path}/util/sqitch" rebase --set env="'${taito_env}'" || "${taito_plugin_path}/util/deploy-changes"
    else
      echo "Deploying changes to database ${taito_env}" && \
      "${taito_plugin_path}/util/deploy-changes"
    fi
  done
) && \

# Call next command on command chain
"${taito_util_path}/call-next" "${@}"
