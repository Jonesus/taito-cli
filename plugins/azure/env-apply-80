#!/bin/bash -e
# shellcheck source=lib/all.bash
. "${taito_plugin_path:?}/lib/all.bash"
: "${taito_env:?}"

default=
if [[ ${kubernetes_name} ]] && [[ ${taito_env} != "dev" ]]; then
  echo "NOTE: You most likely already have configured the Azure credentials."
  default=no
fi

( [[ ${kubernetes_name} ]] && \
    taito::confirm "Configure Azure credentials for CI/CD pipeline" "${default}"
) || taito::skip_to_next "${@}"

echo
echo "Your CI/CD requires Azure service principal access keys."
echo
echo "NOTE: If you have already configured service principal access keys for your"
echo "CI/CD, you can ignore this step. You should use the same CI/CD access key"
echo "for all of your projects on this ${taito_zone} zone."
echo
echo "Make sure to take note of the app id and password."
echo
taito::confirm "Do you really want to generate a new CI/CD access key" "${default}" ||
  taito::skip_to_next

scope="/subscriptions/${taito_provider_billing_account_id:?}/resourceGroups/${taito_zone:?}"

az ad sp create-for-rbac \
  --name "${taito_zone}-ci" \
  --role "Azure Kubernetes Service Cluster User Role" \
  --scopes "${scope}"

echo "Assigning more roles. Please wait..."

az role assignment create \
  --assignee "http://${taito_zone}-ci" \
  --role "AcrPush" \
  --scope "${scope}" \
  --subscription "${taito_provider_billing_account_id}" > /dev/null

az role assignment create \
  --assignee "http://${taito_zone}-ci" \
  --role "AcrPull" \
  --scope "${scope}" \
  --subscription "${taito_provider_billing_account_id}" > /dev/null

echo
echo "Assigned the following roles for the ${taito_zone}-ci service principal:"
echo "- Kubernetes: Azure Kubernetes Service Cluster User Role"
echo "- Container Registry: AcrPush, AcrPull"
echo
echo "Now add the app ID (AZURE_CLIENT_ID) and password (AZURE_CLIENT_SECRET) to your"
echo "CI/CD pipeline according to your CI/CD provider instructions. If you"
echo "configure them on organization/account level, you don't have to configure"
echo "them for each git repository separately. You should mask and encrypt their"
echo "AZURE_CLIENT_SECRET value if your CI/CD provides such an option."
echo
echo "Press enter when done."
read -r

taito::call_next "${@}"
