#!/bin/bash -e
# shellcheck source=../lib/all.bash
. "${taito_plugin_path:?}/lib/all.bash"
: "${taito_env:?}"

# Fetch required secrets from Kubernetes
taito::expose_required_secrets_filter
if [[ ${fetch_secrets:?} == "true" ]]; then
  taito::print_plugin_title
  if [[ ${secret_filter} ]]; then
    echo "Getting secrets from ./secrets/${taito_env:?} for ${secret_filter}"
  else
    echo "Getting secrets from ./secrets/${taito_env:?}"
  fi
  save_to_disk=true
  taito::export_secrets \
    docker-compose::get_secret_value \
    ${save_to_disk} \
    "${secret_filter}"

  # TODO: Remove this? Not required?
  # if [[ ${taito_command} == "test" ]] && [[ ${taito_mode} == "ci" ]]; then
  #   # Save database proxy secret to disk for running tests
  #   taito::save_proxy_secret_to_disk \
  #     docker-compose::get_secret_value
  # fi

  export taito_secrets_retrieved=true
fi

taito::call_next "${@}"
