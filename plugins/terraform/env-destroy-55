#!/bin/bash -e
# shellcheck source=lib/all.bash
. "${taito_plugin_path:?}/lib/all.bash"

# Deployment
taito_build_image_tag=dummy \
  terraform::run destroy "${taito_provider}-deploy" "${taito_env}"

# Uptime provider
[[ ${taito_uptime_provider:-} ]] && \
  terraform::run destroy "${taito_uptime_provider}-uptime" "${taito_env}"

# Targets (databases, etc)
for target in ${taito_targets:-}; do
  terraform::run destroy "${target}" "${taito_env}" "${target}/terraform"
done

# Misc modules
misc_modules=$(
  ls -d scripts/terraform/* | \
    grep "scripts/terraform/misc-" | \
    sed 's|scripts/terraform/||'
)
for misc in ${misc_modules}; do
  terraform::run destroy "${misc}" "${taito_env:?}"
done

# Cloud provider
terraform::run destroy "${taito_provider:-}" "${taito_env:?}"

taito::call_next "${@}"
